# cycleとtime

- `INTERVAL`
    - CV180x: 250,000
    - QEMU: 1,000,000

```c
printf("s %llu\n", r_time());
msdelay(1000);  // 1秒
printf("e: %llu\n", r_time());
msdelay(100);
printf("s %llu\n", r_time());
usdelay(1000000);  // 1秒
printf("e: %llu\n", r_time());
```

## 実機で実行

```bash
s 88973293
e: 113995998    # e - s = 25,022,705 : 25MHz
s 116523118
e: 141547986    # e - s = 25,024,868 : 25MHz
```

# SDCardを使う

## QEMU、実機ともにエラー

- QEMUのvirtはSDカードをサポートしていない。
- していたとしてもmilk-vとはアドレスが違うだろうからQEMUではSDのテストはできない。

```bash
scause 0xd
sepc=0x802072ae stval=0x43100fc
panic: kerneltrap
```

- これはSD0領域をpageマッピングしていなかったせい

```bash
00000000: 0000 0000 0000 0000 0000 0000 0000 0000
00000010: 0000 0000 0000 0000 0000 0000 0000 0000
00000020: 0000 0000 0000 0000 0000 0000 0000 0000
00000030: 0000 0000 0000 0000 0000 0000 0000 0000
00000040: 0000 0000 0000 0000 0000 0000 0000 0000
00000050: 0000 0000 0000 0000 0000 0000 0000 0000
00000060: 0000 0000 0000 0000 0000 0000 0000 0000
00000070: 0000 0000 0000 0000 0000 0000 0000 0000
00000080: 0000 0000 0000 0000 0000 0000 0000 0000
00000090: 0000 0000 0000 0000 701e 3880 0000 0000
000000a0: 0000 0000 0000 0000 3300 0000 0000 0000
000000b0: 901e 3880 0000 0000 e207 2080 0000 0000
000000c0: 0000 0000 0000 0000 901e 3880 0000 0000
000000d0: 001f 3880 0000 0000 5404 2080 0000 0000
000000e0: 0000 0000 0000 0000 3300 0000 0000 0000
000000f0: 0000 0000 0000 0000 d01e 3880 0000 0000
00000100: 0000 0000 0000 0000 e01e 3880 0000 0000
00000110: f01e 3880 0000 0000 f01e 3880 0000 0000
00000120: 001f 3880 0000 0000 4021 3880 0000 0000
00000130: 101f 3880 0000 0000 0010 0000 0000 0000
00000140: 0600 0000 0000 0070 00f0 f7ff 3f00 0000
00000150: 00f0 df83 0000 0000 0080 e183 c0ff ffff
00000160: 0070 d983 0000 0000 00f0 f7ff 3f00 0000
00000170: 801f 3880 0000 0000 c611 2080 0000 0000
00000180: 1284 ef83 0000 0000 107c 3880 0000 0000
00000190: 1022 3880 0000 0000 a54f faa4 4ffa a44f
000001a0: 107c 3880 0000 0000 00f0 df83 0000 0000
000001b0: 0600 0000 0000 0070 00f0 ffff 3f00 0000
000001c0: 901f 3880 0000 0000 2812 2080 0000 0000
000001d0: e01f 3880 0000 0000 6019 2080 0000 0000
000001e0: 0000 0000 0000 0000 1f07 0000 0000 0000
000001f0: 0000 0000 0000 0000 3825 f383 0000 0000
partition[0]: TYPE: 56, LBA = 0x12280000, #SECS = 0x8020
partition[1]: TYPE: 56, LBA = 0x19600000, #SECS = 0x8020
partition[2]: TYPE: 0, LBA = 0x71f0000, #SECS = 0x0
partition[3]: TYPE: 0, LBA = 0x25380000, #SECS = 0x83f3

# 1024

00000000: 0000 0000 0000 0000 0000 0000 0000 0000
00000010: 0000 0000 0000 0000 0000 0000 0000 0000
00000020: 0000 0000 0000 0000 0000 0000 0000 0000
00000030: 0000 0000 0000 0000 0000 0000 0000 0000
00000040: 0000 0000 0000 0000 0000 0000 0000 0000
00000050: 0000 0000 0000 0000 0000 0000 0000 0000
00000060: 0000 0000 0000 0000 0000 0000 0000 0000
00000070: 0000 0000 0000 0000 0000 0000 0000 0000
00000080: 0000 0000 0000 0000 0000 0000 0000 0000
00000090: 0000 0000 0000 0000 0000 0000 0000 0000
000000a0: 0000 0000 0000 0000 0000 0000 0000 0000
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000
000000c0: 0000 0000 0000 0000 0000 0000 0000 0000
000000d0: 0000 0000 0000 0000 0000 0000 0000 0000
000000e0: 0000 0000 0000 0000 0000 0000 0000 0000
000000f0: 0000 0000 0000 0000 0000 0000 0000 0000
00000100: 0000 0000 0000 0000 0000 0000 0000 0000
00000110: 0000 0000 0000 0000 0000 0000 0000 0000
00000120: 0000 0000 0000 0000 0000 0000 0000 0000
00000130: 0000 0000 0000 0000 0000 0000 0000 0000
00000140: 0000 0000 0000 0000 0000 0000 0000 0000
00000150: 0000 0000 0000 0000 0000 0000 0000 0000
00000160: 0000 0000 0000 0000 0000 0000 0000 0000
00000170: 0000 0000 0000 0000 0000 0000 0000 0000
00000180: 0000 0000 0000 0000 0000 0000 0000 0000
00000190: 0000 0000 0000 0000 0000 0000 0000 0000
000001a0: 0000 0000 0000 0000 0000 0000 0000 0000
000001b0: 0000 0000 0000 0000 0000 0000 0000 0000
000001c0: 0000 0000 0000 0000 0000 0000 0000 0000
000001d0: 0000 0000 0000 0000 0000 0000 0000 0000
000001e0: 0000 0000 0000 0000 0000 0000 0000 0000
000001f0: 0000 0000 0000 0000 0000 0000 0000 0000
00000200: 0000 0000 0000 0000 0000 0000 0000 0000
00000210: 0000 0000 0000 0000 0000 0000 0000 0000
00000220: 0000 0000 0000 0000 0000 0000 0000 0000
00000230: 0000 0000 0000 0000 0000 0000 0000 0000
00000240: 0000 0000 0000 0000 0000 0000 0000 0000
00000250: 0000 0000 0000 0000 0000 0000 0000 0000
00000260: 0000 0000 0000 0000 0000 0000 0000 0000
00000270: 0000 0000 0000 0000 0000 0000 0000 0000
00000280: 0000 0000 0000 0000 701e 3880 0000 0000
00000290: 0000 0000 0000 0000 3300 0000 0000 0000
000002a0: 901e 3880 0000 0000 e207 2080 0000 0000
000002b0: 0000 0000 0000 0000 901e 3880 0000 0000
000002c0: 001f 3880 0000 0000 5404 2080 0000 0000
000002d0: 0000 0000 0000 0000 3300 0000 0000 0000
000002e0: 0000 0000 0000 0000 d01e 3880 0000 0000
000002f0: 0000 0000 0000 0000 e01e 3880 0000 0000
00000300: f01e 3880 0000 0000 f01e 3880 0000 0000
00000310: 001f 3880 0000 0000 4021 3880 0000 0000
00000320: 101f 3880 0000 0000 0010 0000 0000 0000
00000330: 0600 0000 0000 0070 00f0 f7ff 3f00 0000
00000340: 00f0 df83 0000 0000 0080 e183 c0ff ffff
00000350: 0070 d983 0000 0000 00f0 f7ff 3f00 0000
00000360: 801f 3880 0000 0000 c611 2080 0000 0000
00000370: 1284 ef83 0000 0000 107c 3880 0000 0000
00000380: 1022 3880 0000 0000 a54f faa4 4ffa a44f
00000390: 107c 3880 0000 0000 00f0 df83 0000 0000
000003a0: 0600 0000 0000 0070 00f0 ffff 3f00 0000
000003b0: 901f 3880 0000 0000 2812 2080 0000 0000
000003c0: e01f 3880 0000 0000 6019 2080 0000 0000
000003d0: 0000 0000 0000 0000 1f07 0000 0000 0000
000003e0: 0000 0000 0000 0000 3825 f383 0000 0000
000003f0: 68c7 6c83 0000 0000 0090 2080 0000 0000

# デバッグプリントを入れる
ver: 0x00050000
vendor 0x0, SD version 0x5, slot status 0x0
nblock: 0, ull_offset: 0x00000000
control0: 0x0, control1: 0x0, control2: 0x0
warn: no card inserted
fail emmc_card_reset 1
fail emmc_ensure_data_mode
panic: failed emmc_read

# カード有無のチェックを外した
ver: 0x00050000
vendor 0x0, SD version 0x5, slot status 0x0
nblock: 0, ull_offset: 0x00000000
control0: 0x0, control1: 0x0, control2: 0x0
debug: status: 0x0
error: clock did not stabilise within 1 second
fail emmc_card_reset 1
fail emmc_ensure_data_mode
panic: failed emmc_read

# ソフトリセットの解除をした
ver: 0x00050000
vendor 0x0, SD version 0x5, slot status 0x0
nblock: 0, ull_offset: 0x00000000
control0: 0x0, control1: 0x0, control2: 0x800000
debug: status: 0x3f70000    # write portected?
control0: 0xf00, control1: 0xb2003
emmc_issue_command: cmd=0x00000000, arg=0x00000000
EMMC_INTERRUPT: 0x00000000
emmc_issue_command_int is success!
cmd: 0x00000000 (0x00000000), result: success
emmc_issue_command: cmd=0x00000008, arg=0x000001aa
EMMC_INTERRUPT: 0x00000000
warn: error occured whilst waiting for command complete interrupt 1: irpts=0x000
cmd: 0x080a0000 (0x000001aa), result: failure
emmc_issue_command: cmd=0x00000005, arg=0x00000000
EMMC_INTERRUPT: 0x00000000
warn: error occured whilst waiting for command complete interrupt 1: irpts=0x000
cmd: 0x05010000 (0x00000000), result: failure
emmc_issue_command: cmd=0x80000029, arg=0x00000000
EMMC_INTERRUPT: 0x00000000
issuing command ACMD41
warn: error occured whilst waiting for command complete interrupt 1: irpts=0x000
cmd: 0x370a0000 (0x00000000), result: failure
error: failed to inquiry ACMD41
fail emmc_card_reset 1
fail emmc_ensure_data_mode
panic: failed emmc_read
```

## emmc.cの使用をやめ、milk-v版のU-Bootからsdhci.cを導入

### `sdhci_init()`まで正常動作

```bash
[0]sdhci_setup_cfg: sdhci_setup_cfg, caps: 0x3f68c832

[0]sdhci_setup_cfg: sdhci_setup_cfg, caps_1: 0x8006077
[0]sdhci_get_cd: sdhci_get_cd reg = 0x083f70000
[0]sdhci_reset: sdhci_reset-234 MMC0 : ctrl_2 = 0x0080
[0]sdhci_reset: reg_0x24C = 0x00000001, reg_200 = 0x00010302
[0]sdhci_reset: reg_0x240 = 0x01000100, reg_0x248 = 0x00000000
[0]sdhci_get_cd: sdhci_get_cd reg = 0x082070000
[0]sdhci_host_init: set IP clock to 375Mhz
[0]sdhci_host_init: Be sure to switch clock source to PLL
[0]sdhci_host_init: XTAL->PLL reg = 0x0
[0]sdhci_host_init: eMMC/SD CLK is 375000000 in FPGA_ASIC
[0]sdhci_init: sdhci_init ok

init: starting sh
$
```
